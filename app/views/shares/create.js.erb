function addCloseBtnListener(element) {
  element.addEventListener("click", (event) => {
    event.preventDefault();
    const form = event.currentTarget.parentNode.parentNode;
    const dataRow = form.nextElementSibling;
    const addButton = document.querySelector(".show-new-share-form");
    form.classList.toggle("hidden");

    if (dataRow){
      dataRow.classList.toggle("hidden");
    }

    if(addButton.classList.contains("hidden")) {
      addButton.classList.remove("hidden")
    }
  })
}

function addEditButtonListener(element) {
  element.addEventListener("click", (event) => {
    event.preventDefault();
    const dataRow = event.currentTarget.parentNode.parentNode;
    const form = dataRow.previousElementSibling;
    form.classList.toggle("hidden");
    dataRow.classList.toggle("hidden");
  })
}

function refreshForm(innerHTML, hide) {
  const newShareForm = document.querySelector('#new_share');
  const addOwnerBtn = document.querySelector(".show-new-share-form");
  newShareForm.innerHTML = innerHTML;
  const closeBtn = newShareForm.querySelector(".close-form-btn")
  if (closeBtn) {
    addCloseBtnListener(closeBtn);
  }

  if (hide) {
    newShareForm.classList.toggle("hidden")
    addOwnerBtn.classList.toggle("hidden");
  }
}

function addShare(shareHTML) {
  const shares = document.getElementById('shares-table');
  shares.insertAdjacentHTML('afterend', shareHTML);
  const shareRow = document.querySelector("[data-share-id = '<%= @share.id %>']")
  const editButton = shareRow.querySelector(".edit-share-info");
  if (editButton) {
    addEditButtonListener(editButton);
  }
  const editForm = document.getElementById("edit_share_<%= @share.id %>");
  const closeEditFormBtn =  editForm.querySelector(".close-form-btn");
  if (closeEditFormBtn) {
    addCloseBtnListener(closeEditFormBtn);
  }
}

<% if @share.errors.any? %>
  refreshForm('<%= j render "shared/share-form", share: @share, form_class:"" %>', false);
<% else %>
  addShare('<%= j render "shared/share-row", share: @share %>');
  refreshForm('<%= j render "shared/share-form", share: Share.new, form_class:"" %>', true);
<% end %>
